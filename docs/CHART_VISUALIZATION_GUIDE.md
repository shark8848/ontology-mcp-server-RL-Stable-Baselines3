# å›¾è¡¨å¯è§†åŒ–åŠŸèƒ½æŒ‡å—

## æ¦‚è¿°

æœ¬ç³»ç»Ÿæ”¯æŒåœ¨Agentå¯¹è¯è¿”å›ä¸­ç›´æ¥å±•ç¤ºå„ç±»æ•°æ®å›¾è¡¨ï¼ŒåŒ…æ‹¬è¶‹åŠ¿å›¾ã€æŸ±çŠ¶å›¾ã€é¥¼å›¾å’Œå¯¹æ¯”å›¾ã€‚å›¾è¡¨ä½œä¸ºAgentå›å¤çš„ä¸€éƒ¨åˆ†å‘ˆç°ï¼Œæ— éœ€å•ç‹¬æ“ä½œã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¯ å¤šæ ‡ç­¾æ„å›¾è¯†åˆ«

ç³»ç»Ÿæ”¯æŒåŒæ—¶è¯†åˆ«å¤šä¸ªç”¨æˆ·æ„å›¾ï¼Œä¾‹å¦‚ï¼š
- "æŸ¥è¯¢è®¢å•å¹¶å±•ç¤ºè¶‹åŠ¿å›¾" â†’ [SEARCH, CHART_REQUEST]
- "æœç´¢iPhoneå¹¶æ˜¾ç¤ºé”€é‡æ’è¡Œ" â†’ [SEARCH, CHART_REQUEST]

### ğŸ“Š æ”¯æŒçš„å›¾è¡¨ç±»å‹

| å›¾è¡¨ç±»å‹ | é€‚ç”¨åœºæ™¯ | å…³é”®è¯ |
|---------|---------|--------|
| è¶‹åŠ¿å›¾ (trend) | æ—¶é—´åºåˆ—æ•°æ® | è¶‹åŠ¿ã€èµ°åŠ¿ã€å˜åŒ–ã€å¢é•¿ |
| æŸ±çŠ¶å›¾ (bar) | æ’å/å¯¹æ¯” | æŸ±çŠ¶å›¾ã€æ’è¡Œã€æ’åã€å¯¹æ¯” |
| é¥¼å›¾ (pie) | åˆ†å¸ƒå æ¯” | é¥¼å›¾ã€å æ¯”ã€åˆ†å¸ƒã€æ¯”ä¾‹ |
| å¯¹æ¯”å›¾ (comparison) | å¤šå¯¹è±¡å¯¹æ¯” | å¯¹æ¯”ã€æ¯”è¾ƒã€å·®å¼‚ |

### ğŸ”§ å¯ç”¨çš„å›¾è¡¨æ•°æ®æ–¹æ³•

**AnalyticsService** æä¾›5ç§æ•°æ®ç”Ÿæˆæ–¹æ³•ï¼š

1. **get_order_trend(days, user_id)** - è®¢å•è¶‹åŠ¿
   - ç»Ÿè®¡æŒ‡å®šå¤©æ•°å†…çš„è®¢å•æ•°é‡å’Œé‡‘é¢å˜åŒ–
   - æ”¯æŒæŒ‰ç”¨æˆ·è¿‡æ»¤

2. **get_category_distribution(user_id)** - å•†å“åˆ†ç±»å æ¯”
   - ç»Ÿè®¡å„åˆ†ç±»å•†å“çš„è®¢å•æ•°é‡
   - ä»¥é¥¼å›¾å½¢å¼å±•ç¤ºåˆ†å¸ƒ

3. **get_user_level_stats()** - ç”¨æˆ·ç­‰çº§ç»Ÿè®¡
   - ç»Ÿè®¡å„ä¼šå‘˜ç­‰çº§çš„ç”¨æˆ·æ•°å’Œæ€»æ¶ˆè´¹
   - æŸ±çŠ¶å›¾å±•ç¤º

4. **get_product_sales_ranking(top_n)** - å•†å“é”€é‡æ’è¡Œ
   - å±•ç¤ºé”€é‡å‰Nåçš„å•†å“
   - åŒ…å«é”€é‡å’Œé”€å”®é¢æ•°æ®

5. **get_user_spending_comparison(user_ids)** - ç”¨æˆ·æ¶ˆè´¹å¯¹æ¯”
   - å¯¹æ¯”å¤šä¸ªç”¨æˆ·çš„æ¶ˆè´¹æƒ…å†µ
   - æ”¯æŒè®¢å•æ•°å’Œæ€»æ¶ˆè´¹å¯¹æ¯”

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: è®¢å•è¶‹åŠ¿å›¾

**ç”¨æˆ·è¾“å…¥**:
```
å±•ç¤ºæœ€è¿‘7å¤©çš„è®¢å•è¶‹åŠ¿å›¾
```

**ç³»ç»Ÿå¤„ç†**:
1. æ„å›¾è¯†åˆ«: `[CHART_REQUEST]`
2. æå–å®ä½“: `chart_types=['trend']`, `days=7`
3. è°ƒç”¨å·¥å…·: `analytics_get_chart_data(chart_type="trend", days=7)`
4. è¿”å›Markdownè¡¨æ ¼ + æè¿°

**å›¾è¡¨è¾“å‡º**:
```markdown
**è®¢å•è¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰**

| æ—¥æœŸ | è®¢å•æ•° | é‡‘é¢(å…ƒ) |
|------|--------|---------|
| 11-17 | 5 | 12,500 |
| 11-18 | 8 | 18,900 |
| 11-19 | 3 | 6,700 |
...
```

### ç¤ºä¾‹2: åˆ†ç±»å æ¯”é¥¼å›¾

**ç”¨æˆ·è¾“å…¥**:
```
ç»™æˆ‘çœ‹çœ‹å„ç±»å•†å“çš„é”€å”®å æ¯”
```

**ç³»ç»Ÿå¤„ç†**:
1. æ„å›¾è¯†åˆ«: `[CHART_REQUEST, SEARCH]`
2. è°ƒç”¨å·¥å…·: `analytics_get_chart_data(chart_type="pie")`

**å›¾è¡¨è¾“å‡º**:
```markdown
**å•†å“åˆ†ç±»å æ¯”**

| åˆ†ç±» | æ•°é‡ | å æ¯” |
|------|------|------|
| æ‰‹æœº | 150 | 45% |
| é…ä»¶ | 80 | 24% |
| ç”µè„‘ | 60 | 18% |
...
```

### ç¤ºä¾‹3: é”€é‡æ’è¡Œæ¦œ

**ç”¨æˆ·è¾“å…¥**:
```
æ˜¾ç¤ºé”€é‡å‰10çš„å•†å“
```

**ç³»ç»Ÿå¤„ç†**:
1. æ„å›¾è¯†åˆ«: `[CHART_REQUEST, SEARCH]`
2. æå–å®ä½“: `top_n=10`
3. è°ƒç”¨å·¥å…·: `analytics_get_chart_data(chart_type="bar", top_n=10)`

**å›¾è¡¨è¾“å‡º**:
```markdown
**å•†å“é”€é‡TOP 10**

| æ’å | å•†å“å | é”€é‡ | é”€å”®é¢ |
|------|--------|------|--------|
| 1 | iPhone 15 Pro Max | 120 | Â¥1,199,880 |
| 2 | iPhone 15 Pro | 95 | Â¥854,905 |
...
```

## æŠ€æœ¯æ¶æ„

### æ•°æ®æµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
æ„å›¾è¯†åˆ« (IntentTracker)
  â†“
Agentæ¨ç† (ReAct Agent)
  â†“
å·¥å…·è°ƒç”¨ (analytics_get_chart_data)
  â†“
æ•°æ®ç”Ÿæˆ (AnalyticsService)
  â†“
å›¾è¡¨æå– (react_agent.py)
  â†“
Markdownæ¸²æŸ“ (gradio_ui.py)
  â†“
æ˜¾ç¤ºç»™ç”¨æˆ·
```

### æ ¸å¿ƒç»„ä»¶

**1. æ„å›¾è¯†åˆ«å±‚** (`intent_tracker.py`)
- æ‰©å±•IntentCategoryæšä¸¾ï¼Œå¢åŠ CHART_REQUESTç±»åˆ«
- recognize()æ–¹æ³•è¿”å›List[Intent]æ”¯æŒå¤šæ ‡ç­¾
- æå–å›¾è¡¨ç±»å‹ã€æ—¶é—´èŒƒå›´ã€Top-Nç­‰å®ä½“

**2. æ•°æ®æœåŠ¡å±‚** (`analytics_service.py`)
- ChartDataæ•°æ®ç±»å®šä¹‰å›¾è¡¨ç»“æ„
- AnalyticsServiceå°è£…5ç§å›¾è¡¨ç”Ÿæˆé€»è¾‘
- ç»Ÿä¸€API: get_chart_data(chart_type, **kwargs)

**3. MCPå·¥å…·å±‚** (`mcp_adapter.py`)
- GetChartDataInput schemaå®šä¹‰6ä¸ªå‚æ•°
- _get_chart_data_toolæ–¹æ³•å¤„ç†å·¥å…·è°ƒç”¨
- æ³¨å†Œä¸ºç¬¬22ä¸ªMCPå·¥å…·

**4. Agentæå–å±‚** (`react_agent.py`)
- ä»tool_logä¸­æå–analytics_get_chart_dataç»“æœ
- è§£æJSONå¹¶æ·»åŠ åˆ°result['charts']åˆ—è¡¨

**5. UIæ¸²æŸ“å±‚** (`gradio_ui.py`)
- _render_charts_htmlæ–¹æ³•è½¬æ¢ä¸ºMarkdownè¡¨æ ¼
- åœ¨å¯¹è¯å›å¤ä¸­åµŒå…¥å›¾è¡¨HTML

## ChartData æ•°æ®ç»“æ„

```python
@dataclass
class ChartData:
    chart_type: str        # å›¾è¡¨ç±»å‹: trend/pie/bar/comparison
    title: str             # å›¾è¡¨æ ‡é¢˜
    labels: List[str]      # Xè½´æ ‡ç­¾æˆ–åˆ†ç±»å
    series: List[Dict]     # ç³»åˆ—æ•°æ®
    description: str       # å›¾è¡¨æè¿°
    metadata: Dict         # å…ƒæ•°æ®ï¼ˆæ—¶é—´èŒƒå›´ã€è¿‡æ»¤æ¡ä»¶ç­‰ï¼‰

# series ç»“æ„ç¤ºä¾‹
series = [
    {
        "name": "è®¢å•æ•°",
        "data": [5, 8, 3, 12, 7, 9, 15]
    },
    {
        "name": "é‡‘é¢",
        "data": [12500, 18900, 6700, ...]
    }
]
```

## MCPå·¥å…·å‚æ•°

**analytics_get_chart_data**

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| chart_type | string | âœ… | å›¾è¡¨ç±»å‹: trend/pie/bar/comparison |
| days | integer | âŒ | æ—¶é—´èŒƒå›´ï¼ˆå¤©æ•°ï¼‰ï¼Œé»˜è®¤30 |
| top_n | integer | âŒ | Top-Næ•°é‡ï¼Œé»˜è®¤10 |
| user_id | integer | âŒ | è¿‡æ»¤ç‰¹å®šç”¨æˆ· |
| user_ids | array | âŒ | å¯¹æ¯”å¤šä¸ªç”¨æˆ·ï¼ˆç”¨äºcomparisonï¼‰ |
| category | string | âŒ | è¿‡æ»¤å•†å“åˆ†ç±» |

**è¿”å›å€¼**:
```json
{
  "chart_type": "trend",
  "title": "è®¢å•è¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰",
  "labels": ["11-17", "11-18", "11-19", ...],
  "series": [
    {"name": "è®¢å•æ•°", "data": [5, 8, 3, ...]},
    {"name": "é‡‘é¢", "data": [12500, 18900, ...]}
  ],
  "description": "ç»Ÿè®¡å‘¨æœŸ: 2025-11-17 è‡³ 2025-11-23",
  "metadata": {
    "start_date": "2025-11-17",
    "end_date": "2025-11-23",
    "total_orders": 45
  }
}
```

## å›¾è¡¨å…³é”®è¯é…ç½®

åœ¨ `intent_tracker.py` ä¸­å®šä¹‰ï¼š

```python
CHART_KEYWORDS = {
    'trend': ['è¶‹åŠ¿', 'èµ°åŠ¿', 'å˜åŒ–', 'å¢é•¿', 'ä¸‹é™'],
    'pie': ['é¥¼å›¾', 'å æ¯”', 'åˆ†å¸ƒ', 'æ¯”ä¾‹', 'ä»½é¢'],
    'bar': ['æŸ±çŠ¶å›¾', 'æ’è¡Œ', 'æ’å', 'å¯¹æ¯”', 'TOP'],
    'comparison': ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'å·®å¼‚', 'ç›¸æ¯”'],
}
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå›¾è¡¨æ²¡æœ‰æ˜¾ç¤ºï¼Ÿ

**å¯èƒ½åŸå› **:
1. æ„å›¾è¯†åˆ«æœªæ£€æµ‹åˆ°CHART_REQUEST
2. å…³é”®è¯ä¸åœ¨é¢„å®šä¹‰åˆ—è¡¨ä¸­
3. æ•°æ®åº“ä¸­æ²¡æœ‰ç›¸å…³æ•°æ®

**è§£å†³æ–¹æ³•**:
- ä½¿ç”¨æ˜ç¡®çš„å…³é”®è¯ï¼ˆå¦‚"å±•ç¤ºè¶‹åŠ¿å›¾"ï¼‰
- æ£€æŸ¥IntentTracker.recognize()è¿”å›çš„intent_labels
- æŸ¥çœ‹tool_logç¡®è®¤å·¥å…·æ˜¯å¦è¢«è°ƒç”¨

### Q2: å›¾è¡¨æ•°æ®ä¸ºç©ºæ€ä¹ˆåŠï¼Ÿ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è®¢å•/å•†å“æ•°æ®
2. ç¡®è®¤æ—¶é—´èŒƒå›´å‚æ•°ï¼ˆdaysï¼‰æ˜¯å¦åˆç†
3. æŸ¥çœ‹AnalyticsServiceæ—¥å¿—è¾“å‡º

### Q3: å¦‚ä½•æ‰©å±•æ–°çš„å›¾è¡¨ç±»å‹ï¼Ÿ

**æ­¥éª¤**:
1. åœ¨`CHART_KEYWORDS`æ·»åŠ æ–°å…³é”®è¯
2. åœ¨`AnalyticsService`å®ç°æ–°çš„ç”Ÿæˆæ–¹æ³•
3. åœ¨`get_chart_data()`æ·»åŠ åˆ†æ”¯å¤„ç†
4. æ›´æ–°`GetChartDataInput` schemaï¼ˆå¦‚éœ€æ–°å‚æ•°ï¼‰

### Q4: å›¾è¡¨æ•°æ®æŸ¥è¯¢é”™è¯¯

**å·²çŸ¥é—®é¢˜**:
å½“å‰ç‰ˆæœ¬çš„`analytics_service.py`åœ¨æ•°æ®åº“æŸ¥è¯¢æ—¶ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å±æ€§ï¼ˆå¦‚`self.service.order_service.list_orders()`ï¼‰ï¼Œéœ€è¦ä¿®å¤ä¸ºç›´æ¥æŸ¥è¯¢æ•°æ®åº“è¡¨ã€‚

**ä¸´æ—¶è§£å†³**:
åœ¨å®é™…è¿è¡ŒMCP Serveræ—¶ï¼ŒCommerceServiceä¼šæ­£ç¡®åˆå§‹åŒ–ï¼Œè¯¥é—®é¢˜ä¸å½±å“ç”Ÿäº§ä½¿ç”¨ã€‚å•å…ƒæµ‹è¯•éœ€è¦mockæ•°æ®åº“å±‚ã€‚

## å¼€å‘ä¸æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
python3 test_chart_feature.py
```

**æµ‹è¯•å†…å®¹**:
- âœ… å¤šæ„å›¾è¯†åˆ«
- âœ… æ„å›¾è·Ÿè¸ªï¼ˆå¤šæ ‡ç­¾ï¼‰
- â¸ï¸ æ•°æ®ç”Ÿæˆï¼ˆå¾…æ•°æ®åº“ä¿®å¤ï¼‰

### æ·»åŠ æ–°å›¾è¡¨æ–¹æ³•

```python
# 1. åœ¨ AnalyticsService æ·»åŠ æ–¹æ³•
def get_custom_chart(self, param1, param2) -> ChartData:
    # æŸ¥è¯¢æ•°æ®
    with self.service.db.SessionLocal() as session:
        data = session.query(Model).filter(...).all()
    
    # å¤„ç†æ•°æ®
    labels = [...]
    series = [{"name": "...", "data": [...]}]
    
    return ChartData(
        chart_type="custom",
        title="è‡ªå®šä¹‰å›¾è¡¨",
        labels=labels,
        series=series,
        description="...",
        metadata={}
    )

# 2. åœ¨ get_chart_data() æ·»åŠ åˆ†æ”¯
elif chart_type == "custom":
    return service.get_custom_chart(param1, param2)

# 3. æ›´æ–° CHART_KEYWORDS
CHART_KEYWORDS['custom'] = ['è‡ªå®šä¹‰', 'ç‰¹æ®Š', ...]
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®ç¼“å­˜**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ç­‰çº§ç»Ÿè®¡ï¼‰æ·»åŠ ç¼“å­˜
2. **å¼‚æ­¥æŸ¥è¯¢**: å¤§æ•°æ®é‡æ—¶ä½¿ç”¨å¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢
3. **é™åˆ¶èŒƒå›´**: é»˜è®¤é™åˆ¶top_nå’Œdayså‚æ•°ï¼Œé¿å…è¿‡å¤§æŸ¥è¯¢
4. **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µï¼ˆcreated_at, user_idï¼‰æ·»åŠ æ•°æ®åº“ç´¢å¼•

## æœªæ¥æ‰©å±•æ–¹å‘

- [ ] æ”¯æŒæ›´å¤šå›¾è¡¨ç±»å‹ï¼ˆæ•£ç‚¹å›¾ã€é›·è¾¾å›¾ã€çƒ­åŠ›å›¾ï¼‰
- [ ] å®æ—¶æ•°æ®æµå›¾è¡¨ï¼ˆWebSocketæ¨é€ï¼‰
- [ ] å›¾è¡¨å¯¼å‡ºåŠŸèƒ½ï¼ˆPNG/PDFï¼‰
- [ ] è‡ªå®šä¹‰å›¾è¡¨é…ç½®ï¼ˆé¢œè‰²ã€æ ·å¼ï¼‰
- [ ] å›¾è¡¨æ•°æ®ç¼“å­˜ä¸å¢é‡æ›´æ–°
- [ ] æ”¯æŒMermaidå›¾è¡¨è¯­æ³•æ¸²æŸ“

## ç›¸å…³æ–‡æ¡£

- [æ„å›¾è¯†åˆ«æŒ‡å—](./INTENT_TRACKING.md)
- [MCPå·¥å…·å¼€å‘](./MCP_TOOLS.md)
- [Gradio UIæŒ‡å—](../GRADIO_UI_GUIDE.md)
- [Agentä½¿ç”¨æŒ‡å—](../AGENT_USAGE.md)
