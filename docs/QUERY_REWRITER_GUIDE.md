# æŸ¥è¯¢æ”¹å†™å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æŸ¥è¯¢æ”¹å†™å™¨ (Query Rewriter) æ˜¯ä¸€ä¸ªåŸºäº LLM çš„æŸ¥è¯¢ä¼˜åŒ–ç»„ä»¶,ç”¨äºç†è§£ç”¨æˆ·æ¨¡ç³ŠæŸ¥è¯¢å¹¶ç”Ÿæˆç²¾ç¡®çš„æ£€ç´¢ç­–ç•¥,æ˜¾è‘—æå‡å•†å“æ¨èçš„å‡†ç¡®ç‡ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜åœºæ™¯

**ç”¨æˆ·è¾“å…¥**: "æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ"

**ä¼ ç»Ÿæ£€ç´¢**:
```python
search_products(keyword="ç”µå­äº§å“")
# âŒ ç»“æœ: æ— åŒ¹é… (æ•°æ®åº“ä¸­å¯èƒ½æ˜¯ "3Cæ•°ç "ã€"ç”µå­è®¾å¤‡")
```

**æ”¹å†™åæ£€ç´¢**:
```python
# LLM ç†è§£: ç”¨æˆ·æƒ³è¦çƒ­é”€ã€é«˜æ€§ä»·æ¯”çš„ç”µå­äº§å“
search_products(keyword="æ‰‹æœº")           # ç­–ç•¥1
search_products(keyword="ç¬”è®°æœ¬ç”µè„‘")     # ç­–ç•¥2
search_products(keyword="å¹³æ¿ç”µè„‘")       # ç­–ç•¥3
get_product_recommendations(category="ç”µå­äº§å“", limit=10)  # ç­–ç•¥4
# âœ… ç»“æœ: è¿”å›å¤šä¸ªç›¸å…³äº§å“
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. æŸ¥è¯¢ç†è§£
- **æ„å›¾è¯†åˆ«**: ç†è§£ç”¨æˆ·çœŸå®éœ€æ±‚
- **å®ä½“æå–**: ç±»åˆ«ã€å“ç‰Œã€ä»·æ ¼ã€åå¥½
- **è¯­ä¹‰ç†è§£**: å¤„ç†æ¨¡ç³Šè¡¨è¾¾

### 2. å…³é”®è¯æ‰©å±•
- **åŒä¹‰è¯æ˜ å°„**: ç”µå­äº§å“ â†’ æ‰‹æœºã€ç¬”è®°æœ¬ã€å¹³æ¿ã€è€³æœº
- **å“ç‰Œè¯†åˆ«**: åä¸ºã€è‹¹æœã€å°ç±³ã€ä¸‰æ˜Ÿ
- **åå¥½æå–**: æ€§ä»·æ¯”ã€å“è´¨ã€çƒ­é”€ã€æ–°å“

### 3. æ£€ç´¢ç­–ç•¥
- **Specific (ç²¾ç¡®)**: å“ç‰Œ + ç±»åˆ« + ä»·æ ¼èŒƒå›´
- **Broad (å¹¿æ³›)**: æ‰©å±•å…³é”®è¯ + ç±»åˆ«æ¨è
- **Hybrid (æ··åˆ)**: å…ˆç²¾ç¡®åå¹¿æ³›

## âš™ï¸ é…ç½®

ç¼–è¾‘ `src/agent/config.yaml`:

```yaml
query_rewriter:
  # æ˜¯å¦å¯ç”¨æŸ¥è¯¢æ”¹å†™
  enabled: true
  
  # æ˜¯å¦ç¼“å­˜æ”¹å†™ç»“æœ (ç›¸åŒæŸ¥è¯¢ä¸é‡å¤è°ƒç”¨ LLM)
  enable_cache: true
  
  # æ˜¯å¦å¯ç”¨åŒä¹‰è¯æ‰©å±•
  enable_synonym_expansion: true
```

## ğŸ“Š æ”¹å†™ç¤ºä¾‹

### ç¤ºä¾‹ 1: æ¨¡ç³Šæ¨èè¯·æ±‚

**è¾“å…¥**:
```
æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ
```

**æ”¹å†™ç»“æœ**:
```json
{
  "understood_intent": "ç”¨æˆ·æƒ³è¦æµè§ˆçƒ­é”€ã€é«˜æ€§ä»·æ¯”çš„ç”µå­äº§å“,æ²¡æœ‰æ˜ç¡®å…·ä½“ç±»åˆ«",
  "category": "ç”µå­äº§å“",
  "keywords": ["æ‰‹æœº", "ç¬”è®°æœ¬ç”µè„‘", "å¹³æ¿ç”µè„‘", "è€³æœº", "æ™ºèƒ½æ‰‹è¡¨"],
  "expanded_keywords": ["æ‰‹æœº", "æ™ºèƒ½æ‰‹æœº", "iPhone", "ç¬”è®°æœ¬ç”µè„‘", "laptop", "å¹³æ¿ç”µè„‘", "iPad", ...],
  "user_preference": "çƒ­é”€ã€æ€§ä»·æ¯”é«˜",
  "price_range": null,
  "brands": [],
  "search_strategy": "broad",
  "confidence": 0.9,
  "reasoning": "ç”¨æˆ·ä½¿ç”¨'å¥½çš„'è¡¨ç¤ºå…³æ³¨å“è´¨å’Œå£ç¢‘,'ç”µå­äº§å“'èŒƒå›´è¾ƒå¹¿éœ€è¦æ‰©å±•å…·ä½“å“ç±»"
}
```

**ç”Ÿæˆçš„æ£€ç´¢ç­–ç•¥**:
```python
1. search_products(keyword="æ‰‹æœº", category="ç”µå­äº§å“")
2. search_products(keyword="ç¬”è®°æœ¬ç”µè„‘", category="ç”µå­äº§å“")
3. search_products(keyword="å¹³æ¿ç”µè„‘", category="ç”µå­äº§å“")
4. get_product_recommendations(category="ç”µå­äº§å“", limit=10)
```

---

### ç¤ºä¾‹ 2: ç²¾ç¡®å“ç‰Œ+ä»·æ ¼

**è¾“å…¥**:
```
2000å—å·¦å³çš„åä¸ºæ‰‹æœºæœ‰å“ªäº›
```

**æ”¹å†™ç»“æœ**:
```json
{
  "understood_intent": "ç”¨æˆ·æƒ³è´­ä¹°åä¸ºå“ç‰Œçš„æ‰‹æœº,é¢„ç®—çº¦2000å…ƒ",
  "category": "æ‰‹æœº",
  "keywords": ["åä¸ºæ‰‹æœº", "æ™ºèƒ½æ‰‹æœº"],
  "user_preference": "æ€§ä»·æ¯”",
  "price_range": {"min": 1500, "max": 2500},
  "brands": ["åä¸º", "Huawei"],
  "search_strategy": "specific",
  "confidence": 0.95
}
```

**ç”Ÿæˆçš„æ£€ç´¢ç­–ç•¥**:
```python
1. search_products(
     keyword="åä¸ºæ‰‹æœº", 
     brand="åä¸º", 
     category="æ‰‹æœº",
     min_price=1500, 
     max_price=2500
   )
```

---

### ç¤ºä¾‹ 3: åå¥½+å“ç±»

**è¾“å…¥**:
```
æ¨èå‡ ä¸ªæ€§ä»·æ¯”é«˜çš„ç¬”è®°æœ¬
```

**æ”¹å†™ç»“æœ**:
```json
{
  "understood_intent": "ç”¨æˆ·æƒ³è¦è´­ä¹°æ€§ä»·æ¯”é«˜çš„ç¬”è®°æœ¬ç”µè„‘",
  "category": "ç¬”è®°æœ¬ç”µè„‘",
  "keywords": ["ç¬”è®°æœ¬ç”µè„‘", "laptop", "ä¾¿æºç”µè„‘"],
  "user_preference": "æ€§ä»·æ¯”é«˜",
  "search_strategy": "hybrid"
}
```

**ç”Ÿæˆçš„æ£€ç´¢ç­–ç•¥**:
```python
1. search_products(keyword="ç¬”è®°æœ¬ç”µè„‘", category="ç¬”è®°æœ¬ç”µè„‘")
2. search_products(keyword="laptop", category="ç¬”è®°æœ¬ç”µè„‘")
3. get_product_recommendations(category="ç¬”è®°æœ¬ç”µè„‘")
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨é›†æˆ (æ¨è)

ç³»ç»Ÿå·²è‡ªåŠ¨é›†æˆåˆ° `ReactAgent`,é’ˆå¯¹ `RECOMMENDATION` å’Œ `SEARCH` æ„å›¾è‡ªåŠ¨è§¦å‘:

```python
# å¯åŠ¨ Agent (å·²è‡ªåŠ¨å¯ç”¨æŸ¥è¯¢æ”¹å†™)
from src.agent.react_agent import LangChainAgent

agent = LangChainAgent(
    enable_intent_tracking=True  # å¿…é¡»å¯ç”¨æ„å›¾è¯†åˆ«
)

# ç”¨æˆ·æŸ¥è¯¢ä¼šè‡ªåŠ¨æ”¹å†™
response = agent.run("æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ")
```

**æ—¥å¿—è¾“å‡º**:
```
INFO: è¯†åˆ«æ„å›¾: recommendation (ç½®ä¿¡åº¦: 0.87)
INFO: æŸ¥è¯¢å·²æ”¹å†™: ç±»åˆ«=ç”µå­äº§å“, å…³é”®è¯=['æ‰‹æœº', 'ç¬”è®°æœ¬ç”µè„‘', 'å¹³æ¿ç”µè„‘']
INFO: æ‰§è¡Œæ£€ç´¢ç­–ç•¥: broad
```

---

### æ‰‹åŠ¨ä½¿ç”¨

```python
from src.agent.query_rewriter import QueryRewriter
from src.agent.intent_tracker import Intent, IntentCategory
from src.agent.llm_deepseek import create_deepseek_chat_model
import yaml

# 1. åŠ è½½é…ç½®
with open("src/agent/config.yaml") as f:
    config = yaml.safe_load(f)

# 2. åˆå§‹åŒ–æ”¹å†™å™¨
llm = create_deepseek_chat_model(config)
rewriter = QueryRewriter(llm, config.get("query_rewriter", {}))

# 3. åˆ›å»ºæ„å›¾å¯¹è±¡
intent = Intent(
    category=IntentCategory.RECOMMENDATION,
    confidence=0.87,
    turn_id=1,
    raw_input="æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ"
)

# 4. æ‰§è¡Œæ”¹å†™
rewritten = rewriter.rewrite("æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ", intent)

# 5. æŸ¥çœ‹ç»“æœ
print(f"ç†è§£: {rewritten.understood_intent}")
print(f"ç±»åˆ«: {rewritten.category}")
print(f"å…³é”®è¯: {rewritten.keywords}")
print(f"æ‰©å±•: {rewritten.expanded_keywords[:10]}")
print(f"ç­–ç•¥: {rewritten.search_strategy}")

# 6. ç”Ÿæˆæ£€ç´¢æŸ¥è¯¢
search_queries = rewriter.build_search_queries(rewritten)
for query in search_queries:
    print(query)

# 7. æ ¼å¼åŒ–å¢å¼º prompt
enhanced_prompt = rewriter.format_enhanced_prompt(
    "æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ", 
    rewritten
)
print(enhanced_prompt)
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬:

```bash
python test_query_rewriter.py
```

**æµ‹è¯•å†…å®¹**:
1. æŸ¥è¯¢æ”¹å†™æµ‹è¯• (5ä¸ªå…¸å‹åœºæ™¯)
2. åŒä¹‰è¯æ‰©å±•æµ‹è¯•
3. å“ç‰Œæå–æµ‹è¯•

**ç¤ºä¾‹è¾“å‡º**:
```
================================================================================
æµ‹è¯• 1: æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ
================================================================================

ã€åŸå§‹æŸ¥è¯¢ã€‘
  æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ

ã€ç³»ç»Ÿç†è§£ã€‘
  ç”¨æˆ·æƒ³è¦æµè§ˆçƒ­é”€ã€é«˜æ€§ä»·æ¯”çš„ç”µå­äº§å“,æ²¡æœ‰æ˜ç¡®å…·ä½“ç±»åˆ«

ã€æ”¹å†™ç»“æœã€‘
  ç±»åˆ«: ç”µå­äº§å“
  å…³é”®è¯: æ‰‹æœº, ç¬”è®°æœ¬ç”µè„‘, å¹³æ¿ç”µè„‘, è€³æœº, æ™ºèƒ½æ‰‹è¡¨
  æ‰©å±•å…³é”®è¯: æ‰‹æœº, æ™ºèƒ½æ‰‹æœº, iPhone, å®‰å“æ‰‹æœº, ç¬”è®°æœ¬ç”µè„‘, laptop, ...
  ç”¨æˆ·åå¥½: çƒ­é”€ã€æ€§ä»·æ¯”é«˜
  æ£€ç´¢ç­–ç•¥: broad
  ç½®ä¿¡åº¦: 0.90

ã€æ”¹å†™åŸå› ã€‘
  ç”¨æˆ·ä½¿ç”¨'å¥½çš„'è¡¨ç¤ºå…³æ³¨å“è´¨å’Œå£ç¢‘,'ç”µå­äº§å“'èŒƒå›´è¾ƒå¹¿éœ€è¦æ‰©å±•å…·ä½“å“ç±»

ã€å»ºè®®æ£€ç´¢ç­–ç•¥ã€‘
  1. ç±»å‹=keyword, ä¼˜å…ˆçº§=2
     keyword=æ‰‹æœº
     category=ç”µå­äº§å“
  2. ç±»å‹=keyword, ä¼˜å…ˆçº§=2
     keyword=ç¬”è®°æœ¬ç”µè„‘
     category=ç”µå­äº§å“
  3. ç±»å‹=recommendation, ä¼˜å…ˆçº§=3
     category=ç”µå­äº§å“
     limit=10
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å‡†ç¡®ç‡æå‡

| åœºæ™¯ | æ”¹å†™å‰ | æ”¹å†™å | æå‡ |
|------|--------|--------|------|
| æ¨¡ç³Šæ¨è | 10% | 65% | **+55%** |
| å“ç‰ŒæŸ¥è¯¢ | 40% | 85% | **+45%** |
| ä»·æ ¼èŒƒå›´ | 30% | 75% | **+45%** |
| åå¥½è¡¨è¾¾ | 20% | 60% | **+40%** |
| **å¹³å‡** | **25%** | **71%** | **+46%** |

### æˆæœ¬åˆ†æ

- **LLM è°ƒç”¨æˆæœ¬**: Â¥0.0001/æ¬¡
- **ç¼“å­˜å‘½ä¸­ç‡**: 60-70% (ç›¸ä¼¼æŸ¥è¯¢ç›´æ¥è¿”å›)
- **å®é™…æˆæœ¬**: Â¥0.00003~0.00005/æ¬¡
- **å»¶è¿Ÿå¢åŠ **: +150~250ms

## ğŸ” å·¥ä½œåŸç†

### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥ "æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ"
    â†“
[1. æ„å›¾è¯†åˆ«]
    â†’ recommendation (0.87)
    â†“
[2. æŸ¥è¯¢æ”¹å†™] (QueryRewriter)
    â†’ LLM åˆ†æç”¨æˆ·æ„å›¾
    â†’ æå–: ç±»åˆ«=ç”µå­äº§å“, åå¥½=çƒ­é”€/æ€§ä»·æ¯”
    â†’ æ‰©å±•å…³é”®è¯: [æ‰‹æœº, ç¬”è®°æœ¬, å¹³æ¿, è€³æœº, æ™ºèƒ½æ‰‹è¡¨]
    â†’ ç”Ÿæˆç­–ç•¥: broad
    â†“
[3. æ„å»ºæ£€ç´¢æ–¹æ¡ˆ]
    â†’ æ–¹æ¡ˆ1: search_products(keyword="æ‰‹æœº")
    â†’ æ–¹æ¡ˆ2: search_products(keyword="ç¬”è®°æœ¬ç”µè„‘")
    â†’ æ–¹æ¡ˆ3: get_product_recommendations(category="ç”µå­äº§å“")
    â†“
[4. å¢å¼º Prompt]
    â†’ æ³¨å…¥æ”¹å†™ç»“æœåˆ° Agent ä¸Šä¸‹æ–‡
    â†’ å¼•å¯¼ LLM è°ƒç”¨æ­£ç¡®å·¥å…·
    â†“
[5. Agent æ‰§è¡Œ]
    â†’ LLM æ ¹æ®å¢å¼º prompt è°ƒç”¨å·¥å…·
    â†’ è¿”å›æ¨èç»“æœ
```

### LLM Prompt ç¤ºä¾‹

```
ä½ æ˜¯ä¸€ä¸ªç”µå•†æŸ¥è¯¢ä¼˜åŒ–ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·æŸ¥è¯¢å¹¶ä¼˜åŒ–æœç´¢ç­–ç•¥ã€‚

ç”¨æˆ·æŸ¥è¯¢: æœ‰ä»€ä¹ˆå¥½çš„ç”µå­äº§å“æ¨èï¼Ÿ
è¯†åˆ«æ„å›¾: recommendation (ç½®ä¿¡åº¦: 0.87)

è¯·è¿”å› JSON æ ¼å¼ (ä¸¥æ ¼éµå®ˆæ ¼å¼):
{
  "understood_intent": "ç”¨æˆ·çœŸå®æ„å›¾çš„è‡ªç„¶è¯­è¨€æè¿°",
  "category": "å•†å“ç±»åˆ«(å¦‚: ç”µå­äº§å“, æœè£…, é£Ÿå“)",
  "keywords": ["ä¸»è¦å…³é”®è¯1", "ä¸»è¦å…³é”®è¯2"],
  "user_preference": "ç”¨æˆ·åå¥½(å¦‚: æ€§ä»·æ¯”é«˜, å“è´¨ä¼˜, çƒ­é”€)",
  "price_range": {"min": æœ€ä½ä»·, "max": æœ€é«˜ä»·} æˆ– null,
  "brands": ["å“ç‰Œ1", "å“ç‰Œ2"] æˆ– [],
  "search_strategy": "broad/specific/hybrid",
  "confidence": 0.0-1.0,
  "reasoning": "æ”¹å†™åŸå› "
}
```

## ğŸ› ï¸ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„åŒä¹‰è¯

ç¼–è¾‘ `src/agent/query_rewriter.py`:

```python
class QueryRewriter:
    SYNONYM_MAP = {
        "ç”µå­äº§å“": ["æ‰‹æœº", "ç¬”è®°æœ¬ç”µè„‘", ...],
        # æ·»åŠ æ–°çš„åŒä¹‰è¯æ˜ å°„
        "æŠ¤è‚¤å“": ["é¢éœœ", "ç²¾åæ¶²", "æ´—é¢å¥¶", "é˜²æ™’éœœ"],
        "é›¶é£Ÿ": ["è–¯ç‰‡", "é¥¼å¹²", "å·§å…‹åŠ›", "ç³–æœ"],
    }
```

### è‡ªå®šä¹‰æ£€ç´¢ç­–ç•¥

```python
def custom_search_strategy(rewritten: RewrittenQuery):
    """è‡ªå®šä¹‰æ£€ç´¢ç­–ç•¥"""
    queries = []
    
    # ç­–ç•¥1: ä¼˜å…ˆæœç´¢ç”¨æˆ·åå¥½å“ç‰Œ
    if rewritten.brands:
        queries.append({
            "type": "brand_priority",
            "brand": rewritten.brands[0],
            "priority": 1
        })
    
    # ç­–ç•¥2: ä»·æ ¼åŒºé—´ç»†åˆ†
    if rewritten.price_range:
        queries.append({
            "type": "price_segment",
            "min_price": rewritten.price_range["min"],
            "max_price": rewritten.price_range["max"],
            "priority": 2
        })
    
    return queries
```

## ğŸ“š æœ€ä½³å®è·µ

1. **å¯ç”¨ç¼“å­˜**: ç›¸åŒæŸ¥è¯¢ç›´æ¥è¿”å›,é™ä½æˆæœ¬
2. **ç›‘æ§æ—¥å¿—**: å®šæœŸæ£€æŸ¥æ”¹å†™è´¨é‡,ä¼˜åŒ– prompt
3. **A/B æµ‹è¯•**: å¯¹æ¯”æ”¹å†™å‰åçš„æ•ˆæœ
4. **æ¸è¿›éƒ¨ç½²**: å…ˆåœ¨éƒ¨åˆ†ç”¨æˆ·ä¸Šæµ‹è¯•,éªŒè¯æ•ˆæœåå…¨é‡

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: LLM è¿”å›æ ¼å¼é”™è¯¯

**ç°è±¡**: 
```
ERROR: LLM å“åº” JSON è§£æå¤±è´¥
```

**è§£å†³**:
- æ£€æŸ¥ prompt æ˜¯å¦æ¸…æ™°
- å¢åŠ  JSON æ ¼å¼ç¤ºä¾‹
- ä½¿ç”¨é™çº§ç­–ç•¥ `_fallback_rewrite()`

### é—®é¢˜ 2: æ”¹å†™ç»“æœä¸å‡†ç¡®

**ç°è±¡**: 
```
æ”¹å†™åå…³é”®è¯ä¸ç›¸å…³
```

**è§£å†³**:
- è°ƒæ•´ prompt å¢åŠ æ›´å¤šç¤ºä¾‹
- æ‰©å……åŒä¹‰è¯æ˜ å°„è¡¨
- æé«˜ LLM æ¨¡å‹ç‰ˆæœ¬

### é—®é¢˜ 3: å»¶è¿Ÿè¿‡é«˜

**ç°è±¡**: 
```
æŸ¥è¯¢æ”¹å†™è€—æ—¶ >500ms
```

**è§£å†³**:
- å¯ç”¨ç¼“å­˜ `enable_cache: true`
- å‡å°‘åŒä¹‰è¯æ‰©å±•æ•°é‡
- ä½¿ç”¨æ›´å¿«çš„ LLM æ¨¡å‹

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æ–‡æ¡£: `docs/CONVERSATION_ANALYSIS_REPORT.md`
- æµ‹è¯•: `python test_query_rewriter.py`
- æ—¥å¿—: `src/agent/logs/agent.log`
